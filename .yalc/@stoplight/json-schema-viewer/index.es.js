import{isRegularNode as e,SchemaNodeKind as l,isReferenceNode as n,SchemaCombinerName as t,isMirroredNode as r,SchemaTree as s}from"@stoplight/json-schema-tree";import{Icon as i,Box as a,Flex as o,Text as u,Select as m,Pressable as c,Provider as d}from"@stoplight/mosaic";import{withErrorBoundary as p}from"@stoplight/react-error-boundary";import h from"classnames";import{createContext as f,useContext as v,createElement as g,Fragment as y,useMemo as x,useState as N,useEffect as b}from"react";import{faChevronDown as w,faChevronRight as O,faExclamationTriangle as L,faCaretDown as k}from"@fortawesome/free-solid-svg-icons";import{pick as $,omit as j,pickBy as A,keys as E,capitalize as T,uniq as C,last as M}from"lodash";import{MarkdownViewer as S}from"@stoplight/markdown-viewer";import{extractPointerFromRef as R,pointerToPath as P}from"@stoplight/json";const z=f({defaultExpandedDepth:0,viewMode:"standalone",hideExamples:!1}),D=()=>v(z),I=z.Provider;function V(e){return null!=e}const q=l=>e(l)&&!!l.children&&l.children.length>0;function J(t){return!!e(t)&&(!(t.primaryType!==l.Array||!V(t.children)||0===t.children.length)&&(1===t.children.length&&(e(t.children[0])||n(t.children[0])&&null!==t.children[0].error)))}function G(l){return J(l)&&e(l.children[0])&&l.children[0].simple}function F(l){return J(l)&&e(l.children[0])&&!l.children[0].simple}function U(l){var n,t;return!e(l)||G(l)?[]:F(l)?null!==(n=l.children[0].children)&&void 0!==n?n:[]:null!==(t=l.children)&&void 0!==t?t:[]}function W(l){var n;const{parent:t}=l;return!(null===t||!e(t)||0===l.subpath.length)&&!!(null===(n=t.required)||void 0===n?void 0:n.includes(l.subpath[l.subpath.length-1]))}t.AllOf,t.AnyOf,t.OneOf;const X={height:12,marginTop:2,left:-25},_=({isExpanded:e})=>g("div",{className:"sl-flex sl-absolute sl-justify-center sl-items-center sl-cursor-pointer sl-text-muted",style:X,role:"button"},g(i,{size:"xs",icon:e?w:O})),B=({value:e})=>g(a,{as:S,markdown:e,style:{"font-size":12}}),H=({schemaNode:l})=>e(l)&&null!==l.format?g("span",{className:"sl-text-muted"},`<${l.format}>`):null;function K(t){return t.primaryType===l.Array&&V(t.children)&&0!==t.children.length?function(l){var t,r,s;if(!V(l.children)||0===l.children.length)return l.title;if(1===l.children.length&&n(l.children[0]))return`$ref(${l.children[0].value})[]`;if(G(l)){const n=null!==(r=null===(t=l.children)||void 0===t?void 0:t.reduce((l,n)=>{if(null===l)return null;if(!e(n))return null;if(null!==n.types&&n.types.length>0)for(const e of n.types)l.includes(e)||l.push(e);return l},[]))&&void 0!==r?r:null;return null!==n&&n.length>0?`array of ${n.join("s/")}s`:"array"}if(F(l)){const e=l.children[0];return e.title?`array of ${e.title}-s`:e.primaryType?`array of ${e.primaryType}s`:(null===(s=e.combiners)||void 0===s?void 0:s.length)?"array of "+e.combiners.join("/"):"array"}return null}(t):t.title}const Q=({schemaNode:t})=>{var r;if(n(t))return g("span",{className:"sl-truncate"},null!==(r=t.value)&&void 0!==r?r:"$ref");if(!e(t))return null;const s=function(e){return[e.types,e.combiners].reduce((e,l)=>(null===l||e.push(...l),e),[])}(t);if(0===s.length)return null;const i=s.map((e,n,{length:r})=>{var s;return g(y,{key:e},g("span",{className:"sl-truncate sl-text-muted"},function(e){return e===l.Array||e===l.Object||"$ref"===e}(e)&&null!==(s=K(t))&&void 0!==s?s:e),n<r-1&&g("span",{key:n+"-sep",className:"sl-text-muted"}," or "))});return i.length>1?g("div",{className:"sl-truncate"},i):g(y,null,i)};Q.displayName="JsonSchemaViewer.Types";const Y=["minimum","maximum","minLength","maxLength","minItems","maxItems","exclusiveMinimum","exclusiveMaximum"],Z=["examples"],ee=["exclusiveMinimum","exclusiveMaximum","readOnly","writeOnly"],le={minimum:e=>">= "+e,exclusiveMinimum:e=>"> "+e,minItems:e=>`>= ${e} items`,minLength:e=>`>= ${e} characters`,maximum:e=>"<= "+e,exclusiveMaximum:e=>"< "+e,maxItems:e=>`<= ${e} items`,maxLength:e=>`<= ${e} characters`},ne=(e,l)=>n=>{const t=Array.isArray(n)?n:[n];return t.length?{name:(null==l?void 0:l.exact)?e:t.length>1?e+" values":e+" value",values:t.map((r=null==l?void 0:l.nowrap,e=>r&&"string"==typeof e?e:JSON.stringify(e)))}:null;var r},te={enum:ne("Allowed"),examples:ne("Example"),multipleOf:ne("Multiple of",{exact:!0}),pattern:ne("Match pattern",{exact:!0,nowrap:!0}),default:ne("Default")},re={int32:{minimum:0-2**31,maximum:2**31-1},int64:{minimum:0-2**63,maximum:2**63-1},float:{minimum:0-2**128,maximum:2**128-1},double:{minimum:0-Number.MAX_VALUE,maximum:Number.MAX_VALUE},byte:{pattern:"^[\\w\\d+\\/=]*$"}};const se=({validations:e,hideExamples:l})=>{const n=$(e,Y),t=j(A(e,e=>["true","false"].includes(String(e))),ee),r=j(e,[...E(n),...E(t),...ee,...l?Z:[]]);return g(y,null,g(ie,{validations:n}),g(ae,{validations:r}),g(ue,{validations:t}))},ie=({validations:e})=>{const l=Object.entries(e);return l.length?g(o,{my:2,color:"muted"},l.map(([e,l])=>le[e](l)).map((e,l)=>g(me,{key:l,name:e,className:"sl-mr-2"}))):null},ae=({validations:e})=>g(y,null,E(e).filter(e=>Object.keys(te).includes(e)).map(l=>{const n=te[l](e[l]);return n?g(oe,{key:l,name:n.name,values:n.values}):null})),oe=({name:e,values:l})=>g(o,{flexWrap:!0,color:"muted",my:2},g(u,{color:"light"},T(e),":"),C(l).map(e=>g(me,{key:e,name:e,className:"sl-ml-2"}))),ue=({validations:e})=>g(y,null,E(e).length?g(o,{flexWrap:!0,my:2},E(e).filter(l=>e[l]).map(e=>g(me,{key:e,name:e,className:"sl-mr-2 sl-text-muted sl-capitalize"}))):null),me=({name:e,className:l})=>g(u,{px:1,fontFamily:"mono",bg:"canvas-100",border:!0,rounded:"lg",className:l},e);function ce(e){return Object.assign(Object.assign(Object.assign({},null!==e.enum?{enum:e.enum}:null),"annotations"in e?Object.assign(Object.assign({},e.annotations.default?{default:e.annotations.default}:null),e.annotations.examples?{examples:e.annotations.examples}:null):null),function(e){if(null!==e.format)return function(e,l){if(!(e in re))return l;const n=Object.assign({},l);for(const[l,t]of Object.entries(re[e]))t===n[l]&&delete n[l];return n}(e.format,e.validations);return e.validations}(e))}const de={paddingLeft:25},pe=({childNodes:e,currentNestingLevel:l,className:n,RowComponent:t=Ne})=>g(a,{bg:"canvas",className:n,style:de},e.map((e,n)=>g(y,{key:e.id},n>0&&g(a,{borderT:!0,borderColor:"light",alignSelf:"stretch"}),g(t,{schemaNode:e,nestingLevel:l+1})))),he=({required:e,deprecated:l,validations:{readOnly:n,writeOnly:t}})=>{const{viewMode:r}=D(),s="standalone"===r&&!!n!=!!t?g("span",{className:"sl-ml-2 sl-text-muted"},n?"read-only":"write-only"):null;return g(y,null,l?g("span",{className:"sl-ml-2 sl-text-warning"},"deprecated"):null,s,e&&g("span",{className:"sl-ml-2 sl-text-warning"},"required"))};function fe(l,t){const r=t?"-s":"",s=t?"s":"";if(e(l)){const e=K(l);return e?e+r:null!==l.primaryType?l.primaryType+s:"any"}if(n(l)){if(l.value){const e=R(l.value),n=!l.error&&e?M(P(e)):null;if("string"==typeof n)return n.split(".")[0]+r}return"$ref"+s}return"any"}function ve(e,l){return{type:e,title:`${l+1}. ${fe(e,!1)}`}}function ge(e,l){const n=fe(e,!0);return{type:e,title:`${l+1}. ${"any"!==n?"array of "+n:"array"}`}}const ye=e=>{const l=x(()=>F(e)&&q(e.children[0])&&xe(e.children[0])?e.children[0].children.map(ge):q(e)&&xe(e)?e.children.map(ve):[ve(e,0)],[e]),n=l[0],[t,r]=N(n);b(()=>{r(n)},[n]);return{selectedChoice:t&&l.includes(t)?t:n,setSelectedChoice:r,choices:l}},xe=e=>{var l,n;return q(e)&&["anyOf","oneOf"].includes(null!==(n=null===(l=e.combiners)||void 0===l?void 0:l[0])&&void 0!==n?n:"")},Ne=({schemaNode:t,nestingLevel:s})=>{const a=e(t)?t.annotations.description:null,{defaultExpandedDepth:o,renderRowAddon:u,onGoToRef:c,hideExamples:d}=D(),[p,f]=N(!r(t)&&s<=o),{selectedChoice:v,setSelectedChoice:b,choices:w}=ye(t),O=v.type,k=x(()=>{var r,s,i;return n(t)?t:e(t)&&(J(t)||t.primaryType===l.Array&&1===(null===(r=t.children)||void 0===r?void 0:r.length))&&null!==(i=null===(s=t.children)||void 0===s?void 0:s.find(n))&&void 0!==i?i:null},[t]),$="string"==typeof(null==k?void 0:k.error),j=x(()=>U(O),[O]);return g("div",{className:"sl-relative"},g("div",{className:"sl-flex"},g("div",{className:"sl-min-w-0 sl-flex-grow"},g("div",{onClick:j.length>0?()=>f(!p):void 0,className:h({"sl-cursor-pointer":j.length>0})},g("div",{className:"sl-flex sl-items-center sl-my-2"},j.length>0?g(_,{isExpanded:p}):null,g("div",{className:"sl-flex sl-items-baseline sl-text-base sl-flex-1"},t.subpath.length>0&&function(e){return 2===e.subpath.length&&("properties"===e.subpath[0]||"patternProperties"===e.subpath[0])}(t)&&g("div",{className:"sl-mr-2 sl-font-mono sl-font-semibold"},M(t.subpath)),1===w.length&&g(y,null,g(Q,{schemaNode:O}),g(H,{schemaNode:O})),c&&n(t)&&t.external?g("a",{className:"sl-ml-2 sl-cursor-pointer sl-text-primary-light",onClick:e=>{e.preventDefault(),e.stopPropagation(),c(t)}},"(go to ref)"):null,t.subpath.length>1&&"patternProperties"===t.subpath[0]?g("div",{className:"sl-ml-2 sl-text-muted"},"(pattern property)"):null,w.length>1&&g(m,{"aria-label":"Pick a type",size:"sm",options:w.map((e,l)=>({value:String(l),label:e.title})),value:String(w.indexOf(v)),onChange:e=>b(w[e])})),g(he,{required:W(t),deprecated:e(t)&&t.deprecated,validations:e(t)?t.validations:{}})),"string"==typeof a&&a.length>0&&g("div",{className:"sl-flex sl-flex-1 sl-my-2 sl-text-base"},g(B,{value:a}))),g(se,{validations:e(t)?ce(t):{},hideExamples:d}),$&&g(i,{title:k.error,color:"danger",icon:L,size:"sm"})),g("div",null,u?u({schemaNode:t,nestingLevel:s}):null)),j.length>0&&p?g(pe,{childNodes:j,currentNestingLevel:s}):null)};const be=({schemaNode:l,nestingLevel:n})=>{const{selectedChoice:t,setSelectedChoice:r,choices:s}=ye(l),a=x(()=>U(t.type),[t.type]);return e(l)&&we(l)?g(Oe,null,g(pe,{childNodes:a,currentNestingLevel:n})):e(l)&&s.length>1?g(Oe,null,g("div",{className:"sl-relative"},g(m,{"aria-label":"Pick a type",size:"sm",options:s.map((e,l)=>({value:String(l),label:e.title})),value:String(s.indexOf(t)),onChange:e=>r(s[e]),renderTrigger:e=>g(c,Object.assign({},e),g("div",{className:"sl-mr-2 sl-font-mono sl-font-semibold sl-text-base sl-flex sl-cursor-pointer sl-py-2"},t.title,g("div",{className:"sl-ml-1"},g(i,{icon:k}))))}),a.length>0?g(pe,{childNodes:a,currentNestingLevel:n}):null)):F(l)&&we(l.children[0])?g(Oe,null,g("div",{className:"sl-relative"},g("div",{className:"sl-mr-2 sl-font-mono sl-font-semibold sl-text-base sl-py-2"},"array of:"),a.length>0?g(pe,{childNodes:a,currentNestingLevel:n}):null)):g(Ne,{schemaNode:l,nestingLevel:n})};function we(e){var l;return"object"===e.primaryType&&1===(null===(l=e.types)||void 0===l?void 0:l.length)}const Oe=({children:e})=>g("div",{style:{marginLeft:-25}},e),Le=p(({schema:l,viewMode:n="standalone",className:t,resolveRef:r,emptyText:i="No schema defined",defaultExpandedDepth:o=2,onGoToRef:u,renderRowAddon:m,hideExamples:c})=>{const p=x(()=>{const t=new s(l,{mergeAllOf:!0,refResolver:r});return t.walker.hookInto("filter",l=>{if(!e(l))return!0;const{validations:t}=l;return!!t.writeOnly==!!t.readOnly||!("read"===n&&t.writeOnly||"write"===n&&t.readOnly)}),t.populate(),t.root},[l,r,n]),f=x(()=>p.children.every(l=>!e(l)||l.unknown),[p]),v=x(()=>({defaultExpandedDepth:o,viewMode:n,onGoToRef:u,renderRowAddon:m,hideExamples:c}),[o,n,u,m,c]);return f?g(a,{className:h(t,"JsonSchemaViewer","sl-text-sm")},i):g(d,null,g(I,{value:v},g(pe,{childNodes:p.children,currentNestingLevel:-1,className:h(t,"JsonSchemaViewer","sl-text-sm"),RowComponent:be})))},{FallbackComponent:({error:e})=>g(a,{p:4},g("b",{className:"text-danger"},"Error"),null!==e?": "+e.message:null),recoverableProps:["schema"],reportErrors:!1});export{Le as JsonSchemaViewer,se as Validations};
//# sourceMappingURL=index.es.js.map
